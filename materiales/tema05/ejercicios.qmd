---
title: "Ejercicios - La Gramática de los Gráficos con ggplot2"
lang: es
---

## Ejercicio 1: Gráficos de Dispersión Básicos

Usando `datos_mercados`:

**Tareas:**

1. Crea un gráfico de dispersión mostrando la relación entre `CantMC` (eje x) y `PartProdIndigena` (eje y).

2. Añade color al gráfico para diferenciar por `Año` usando `color = factor(Año)`.

3. Aumenta el tamaño de los puntos usando `size = 2`.

4. Guarda el gráfico en una variable llamada `grafico_indigena`.

5. ¿Qué patrón observas entre la cantidad de mercados y la participación indígena?

::: {.callout-note collapse="true"}
## Ver Solución

```{r}
#| eval: false
grafico_indigena <- ggplot(
  datos_mercados,
  aes(x = CantMC, y = PartProdIndigena, color = factor(Año))
) +
  geom_point(size = 2)

grafico_indigena
```

La participación indígena generalmente es baja y no muestra una relación fuerte con la cantidad de mercados.

:::

---

## Ejercicio 2: Gráficos de Barras y Conteos

Usando `datos_mercados`:

**Tareas:**

1. Crea un gráfico de barras que cuente cuántos mercados hay por `NombreUPL`. ¿Cuál es la UPL con más mercados?

2. Crea otro gráfico que muestre el promedio de `PartProdAfro` por `Trimestre` usando `geom_col()`. 
   - Primero agrupa los datos por `Trimestre` y calcula el promedio
   - Luego visualiza con barras en color `"coral"`

3. Crea un gráfico que cuente los mercados por `Año`. ¿En qué año hay más datos registrados?

::: {.callout-note collapse="true"}
## Ver Solución

```{r}
#| eval: false
# Ejercicio 1: Barras por UPL
ggplot(datos_mercados, aes(x = NombreUPL)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Ejercicio 2: Promedio de PartProdAfro por Trimestre
datos_mercados |>
  group_by(Trimestre) |>
  summarise(promedio_afro = mean(PartProdAfro, na.rm = TRUE)) |>
  ggplot(aes(x = factor(Trimestre), y = promedio_afro)) +
  geom_col(fill = "coral")

# Ejercicio 3: Conteo por Año
ggplot(datos_mercados, aes(x = factor(Año))) +
  geom_bar()
```

La UPL con más mercados varía según los datos. El año con más registros dependerá de tu dataset.

:::

---

## Ejercicio 3: Histogramas y Distribuciones

Usando `datos_mercados`:

**Tareas:**

1. Crea un histograma de `PartProdJoven` con 25 bins. Describe la forma de la distribución.

2. Crea un histograma de `PartProd` con 30 bins en color `"steelblue"`.

3. Crea un gráfico de densidad de `PartProdMayor` coloreado por `Trimestre` con transparencia (`alpha = 0.5`).

4. ¿Cuál es la participación más común para personas mayores?

::: {.callout-note collapse="true"}
## Ver Solución

```{r}
#| eval: false
# Ejercicio 1: Histograma PartProdJoven
ggplot(datos_mercados, aes(x = PartProdJoven)) +
  geom_histogram(bins = 25)

# Ejercicio 2: Histograma PartProd
ggplot(datos_mercados, aes(x = PartProd)) +
  geom_histogram(bins = 30, fill = "steelblue")

# Ejercicio 3: Densidad PartProdMayor por Trimestre
ggplot(datos_mercados, aes(x = PartProdMayor, fill = factor(Trimestre))) +
  geom_density(alpha = 0.5)
```

La participación más común para personas mayores generalmente se encuentra en los valores bajos, indicando una presencia limitada de este grupo.

:::

---

## Ejercicio 4: Diagramas de Caja

Usando `datos_mercados`:

**Tareas:**

1. Crea un boxplot que compare `PartProdDiscap` (eje y) según `Año` (eje x) en color `"lightgreen"`.

2. Crea otro boxplot que muestre `PartProdMujer` según `Trimestre` con fill = `"lightblue"`.

3. Interpreta el primer boxplot:
   - ¿Cuál es el año con mayor mediana de participación de personas discapacitadas?
   - ¿Hay valores atípicos?

::: {.callout-note collapse="true"}
## Ver Solución

```{r}
#| eval: false
# Ejercicio 1: Boxplot PartProdDiscap por Año
ggplot(datos_mercados, aes(x = factor(Año), y = PartProdDiscap)) +
  geom_boxplot(fill = "lightgreen")

# Ejercicio 2: Boxplot PartProdMujer por Trimestre
ggplot(datos_mercados, aes(x = factor(Trimestre), y = PartProdMujer)) +
  geom_boxplot(fill = "lightblue")
```

La mediana de participación de personas discapacitadas es generalmente baja. Si hay años con valores superiores, serán visibles como barras horizontales más altas dentro de las cajas. Los puntos fuera de los "bigotes" del boxplot serían valores atípicos.

:::

---

## Ejercicio 5: Personalización Completa

Usando `datos_mercados`:

**Tareas:**

1. Crea un gráfico de dispersión con:
   - `x = CantMC`, `y = PartProdVictima`
   - Color según `factor(Año)`
   - Tamaño según `PartProdMujer`
   - Transparencia de 0.6

2. Personaliza el gráfico con:
   - Título: "Relación entre Mercados y Participación de Víctimas"
   - Subtítulo: "Mercados Campesinos de Bogotá"
   - Etiqueta x: "Cantidad de Mercados"
   - Etiqueta y: "Participación de Víctimas (%)"
   - Etiqueta color: "Año"
   - Etiqueta size: "% Mujeres"

3. Aplica `theme_minimal()` al gráfico.

4. Guarda el gráfico como PNG en la carpeta `resultados/` con nombre `gráfico_víctimas.png` usando `ggsave()`.

::: {.callout-note collapse="true"}
## Ver Solución

```{r}
#| eval: false
grafico_completo <- ggplot(
  datos_mercados,
  aes(
    x = CantMC,
    y = PartProdVictima,
    color = factor(Año),
    size = PartProdMujer
  )
) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Relación entre Mercados y Participación de Víctimas",
    subtitle = "Mercados Campesinos de Bogotá",
    x = "Cantidad de Mercados",
    y = "Participación de Víctimas (%)",
    color = "Año",
    size = "% Mujeres"
  ) +
  theme_minimal()

ggsave(
  filename = "resultados/gráfico_víctimas.png",
  plot = grafico_completo,
  width = 10,
  height = 6
)
```

El gráfico muestra la relación entre el tamaño de los mercados y la participación de víctimas del conflicto, con información adicional sobre años y participación femenina.

:::

---

## Ejercicio 6: Pipeline Completo de Visualización

**Tareas:**

Realiza el siguiente análisis:

1. Filtra los datos para el año 2025 únicamente.

2. Calcula el promedio de `PartProdIndigena`, `PartProdAfro`, y `PartProdDiscap` por `NombreUPL`.

3. Crea un gráfico de barras agrupadas mostrando estos tres promedios por UPL:
   - Usa `position = "dodge"` para barras lado a lado
   - Colorea las barras según el grupo de población
   - Personaliza con título y etiquetas claras

4. ¿Cuáles son las 3 UPLs con mayor participación de poblaciones vulnerables en total?

::: {.callout-note collapse="true"}
## Ver Solución

```{r}
#| eval: false
# Paso 1-2: Preparar datos
datos_2025 <- datos_mercados |>
  filter(Año == 2025) |>
  group_by(NombreUPL) |>
  summarise(
    Indígena = mean(PartProdIndigena, na.rm = TRUE),
    Afro = mean(PartProdAfro, na.rm = TRUE),
    Discapacitados = mean(PartProdDiscap, na.rm = TRUE),
    .groups = "drop"
  )

# Paso 3: Transformar para gráfico de barras agrupadas
datos_2025_long <- datos_2025 |>
  pivot_longer(
    cols = c(Indígena, Afro, Discapacitados),
    names_to = "Grupo",
    values_to = "Promedio"
  )

# Crear gráfico
ggplot(datos_2025_long, aes(x = NombreUPL, y = Promedio, fill = Grupo)) +
  geom_col(position = "dodge") +
  labs(
    title = "Participación de Poblaciones Vulnerables por UPL",
    subtitle = "Año 2025",
    x = "Unidad de Planeación Local",
    y = "Participación Promedio (%)",
    fill = "Grupo Poblacional"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Paso 4: Identificar UPLs con mayor participación
datos_2025 |>
  mutate(Total = Indígena + Afro + Discapacitados) |>
  arrange(desc(Total)) |>
  head(3)
```

Las UPLs con mayor participación de poblaciones vulnerables serán aquellas con los valores totales más altos en la suma de los tres grupos.

:::
